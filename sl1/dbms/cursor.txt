SET SERVEROUTPUT ON;

DECLARE
    -- Cursor parameterized by roll number
    CURSOR c_new_roll(p_roll_no N_Roll_Call.roll_no%TYPE) IS
        SELECT roll_no, student_name, department
        FROM N_Roll_Call
        WHERE roll_no = p_roll_no;

    -- Variables to hold row data
    v_roll_no     N_Roll_Call.roll_no%TYPE;
    v_student_name N_Roll_Call.student_name%TYPE;
    v_department   N_Roll_Call.department%TYPE;
    
    -- Variable for existence check
    v_count NUMBER;

BEGIN
    DBMS_OUTPUT.PUT_LINE('--- Starting Merge from N_Roll_Call â†’ O_Roll_Call ---');

    -- Loop through each record in N_Roll_Call
    FOR rec IN (SELECT roll_no FROM N_Roll_Call)
    LOOP
        -- Open parameterized cursor for each roll_no
        OPEN c_new_roll(rec.roll_no);
        FETCH c_new_roll INTO v_roll_no, v_student_name, v_department;

        IF c_new_roll%FOUND THEN
            -- Check if this roll_no already exists in O_Roll_Call
            SELECT COUNT(*) INTO v_count
            FROM O_Roll_Call
            WHERE roll_no = v_roll_no;

            IF v_count = 0 THEN
                -- Insert new record since it doesn't exist
                INSERT INTO O_Roll_Call(roll_no, student_name, department)
                VALUES(v_roll_no, v_student_name, v_department);
                DBMS_OUTPUT.PUT_LINE('Inserted Roll No: ' || v_roll_no);
            ELSE
                DBMS_OUTPUT.PUT_LINE('Skipped Roll No (already exists): ' || v_roll_no);
            END IF;
        END IF;

        CLOSE c_new_roll;
    END LOOP;

    DBMS_OUTPUT.PUT_LINE('--- Merge Completed Successfully ---');
    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
        ROLLBACK;
END;
/
